# ============================================================================
# MAIN PROCESSING FUNCTION
# ============================================================================

function Process-FileServerAudit {
    # Validate UNC path
    if (-not (Test-Path $UNCPath)) {
        Write-Log "UNC path not accessible: $UNCPath" -Level ERROR
        return
    }
    
    # Connect to database
    $sqlConnection = Get-SqlConnection
    Initialize-Database -Connection $sqlConnection
    
    # Initialize Azure Storage
    try {
        $storageContext = Initialize-AzureStorage
    }
    catch {
        Write-Log "Proceeding without Azure Storage. Archive functionality will be disabled." -Level WARNING
        $storageContext = $null
    }
    
    # Build folder structure map
    Write-Log "Building folder structure map..." -Level INFO
    $folderMap = @{}
    
    # Get all folders
    Write-Log "Scanning folder structure: $UNCPath" -Level INFO
    $folders = @(Get-Item -Path $UNCPath) + @(Get-ChildItem -Path $UNCPath -Recurse -Directory -ErrorAction SilentlyContinue)
    $totalFolders = $folders.Count
    Write-Log "Found $totalFolders folders to process" -Level INFO
    
    $folderCount = 0
    foreach ($folder in $folders) {
        $folderCount++
        
        try {
            # Calculate folder level
            $relativePath = $folder.FullName.Replace($UNCPath, "").TrimStart('\')
            $level = if ($relativePath -eq "") { 0 } else { ($relativePath.Split('\').Count) }
            
            # Get parent path
            $parentPath = if ($folder.Parent) { $folder.Parent.FullName } else { $null }
            
            Write-Log "[$folderCount/$totalFolders] Processing folder: $($folder.Name) (Level: $level)" -Level INFO
            
            # Insert folder structure
            $folderId = Add-FolderStructureRecord -Connection $sqlConnection -FolderInfo $folder -ParentPath $parentPath -Level $level
            
            if ($folderId) {
                # Store in map for later reference
                $folderMap[$folder.FullName] = $folderId
                
                # Get and store folder permissions
                $folderPermissions = Get-FolderPermissions -Path $folder.FullName
                Add-FolderPermissionRecords -Connection $sqlConnection -FolderStructureId $folderId -Permissions $folderPermissions
                
                Write-Log "  -> Folder ID: $folderId, Permissions: $($folderPermissions.Count)" -Level INFO
            }
        }
        catch {
            Write-Log "Error processing folder $($folder.FullName): $($_.Exception.Message)" -Level ERROR
        }
    }
    
    Write-Log "Folder structure mapping complete" -Level SUCCESS
    
    # Get all files
    Write-Log "Scanning files in: $UNCPath" -Level INFO
    $files = Get-ChildItem -Path $UNCPath -Recurse -File -ErrorAction SilentlyContinue
    $totalFiles = $files.Count
    Write-Log "Found $totalFiles files to process" -Level INFO
    
    $processedCount = 0
    $archivedCount = 0
    $errorCount = 0
    $currentDate = Get-Date
    
    foreach ($file in $files) {
        $processedCount++
        
        try {
            # Calculate days since last access and modification
            $daysSinceAccess = ($currentDate - $file.LastAccessTime).Days
            $daysSinceModified = ($currentDate - $file.LastWriteTime).Days
            
            # Get folder ID from map
            $folderId = $folderMap[$file.DirectoryName]
            
            # Determine status
            if ($daysSinceAccess -le $InactiveDaysThreshold) {
                $status = "Active"
                $isArchived = $false
                $archiveURL = $null
                $checksum = $null
                
                Write-Log "[$processedCount/$totalFiles] Processing (Active): $($file.Name) - Last accessed: $daysSinceAccess days ago" -Level INFO
                
                # Insert into database
                $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -FolderStructureId $folderId -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess -DaysSinceModified $daysSinceModified
                
                if ($fileAuditId) {
                    # Add file permissions
                    $permissions = Get-FilePermissions -Path $file.FullName
                    Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                    
                    # Display permission summary
                    $writeUsers = ($permissions | Where-Object { $_.CanWrite -or $_.CanModify -or $_.FullControl }).Identity -join ", "
                    if ($writeUsers) {
                        Write-Log "  -> Owner: $(Get-FileOwner -Path $file.FullName)" -Level INFO
                        Write-Log "  -> Users with write/edit access: $writeUsers" -Level INFO
                    }
                }
            }
            else {
                # File is inactive - archive it
                Write-Log "[$processedCount/$totalFiles] Processing (Inactive - Archiving): $($file.Name) - Last accessed: $daysSinceAccess days ago" -Level WARNING
                
                # Calculate checksum before archiving
                $checksum = Get-FileChecksum -Path $file.FullName
                
                if ($storageContext) {
                    # Upload to Azure Storage
                    $archiveURL = Copy-ToAzureStorage -FilePath $file.FullName -StorageContext $storageContext
                    
                    if ($archiveURL) {
                        # Verify checksum
                        $checksumMatch = Verify-ArchiveChecksum -OriginalChecksum $checksum -BlobUrl $archiveURL -StorageContext $storageContext
                        
                        if ($checksumMatch) {
                            $status = "Archived"
                            $isArchived = $true
                            
                            # Insert into database
                            $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -FolderStructureId $folderId -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess -DaysSinceModified $daysSinceModified
                            
                            if ($fileAuditId) {
                                # Add permissions before deletion
                                $permissions = Get-FilePermissions -Path $file.FullName
                                Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                                
                                # Delete original file
                                Remove-Item -Path $file.FullName -Force
                                Write-Log "  -> Successfully archived and deleted. Archive URL: $archiveURL" -Level SUCCESS
                                $archivedCount++
                            }
                        }
                        else {
                            Write-Log "  -> Checksum mismatch - File NOT deleted" -Level ERROR
                            $errorCount++
                        }
                    }
                    else {
                        Write-Log "  -> Failed to upload - File NOT deleted" -Level ERROR
                        $errorCount++
                    }
                }
                else {
                    # No storage context - just mark as inactive
                    $status = "Inactive"
                    $isArchived = $false
                    $archiveURL = $null
                    
                    $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -FolderStructureId $folderId -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess -DaysSinceModified $daysSinceModified
                    
                    if ($fileAuditId) {
                        $permissions = Get-FilePermissions -Path $file.FullName
                        Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                    }
                }
            }
            
            # Progress indicator
            if ($processedCount % 50 -eq 0) {
                $percentComplete = [math]::Round(($processedCount / $totalFiles) * 100, 2)
                Write-Log "Progress: $processedCount/$totalFiles files processed ($percentComplete%)" -Level INFO
            }
        }
        catch {
            Write-Log "Error processing file $($file.FullName): $($_.Exception.Message)" -Level ERROR
            $errorCount++
        }
    }
    
    # Update folder statistics
    Write-Log "Updating folder statistics..." -Level INFO
    foreach ($folderPath in $folderMap.Keys) {
        try {
            $folderId = $folderMap[$folderPath]
            
            # Count files in this folder
            $filesInFolder = Get-ChildItem -Path $folderPath -File -ErrorAction SilentlyContinue
            $fileCount = $filesInFolder.Count
            $totalSize = ($filesInFolder | Measure-Object -Property Length -Sum).Sum
            
            # Count immediate subfolders
            $subfolders = Get-ChildItem -Path $folderPath -Directory -ErrorAction SilentlyContinue
            $subfolderCount = $subfolders.Count
            
            Update-FolderStatistics -Connection $sqlConnection -FolderId $folderId -FileCount $fileCount -SubfolderCount $subfolderCount -TotalSize $totalSize
        }
        catch {
            Write-Log "Error updating folder statistics for $folderPath : $($_.Exception.Message)" -Level WARNING
        }
    }
    
    # Close database connection
    $sqlConnection.Close()
    
    # Summary
    Write-Log "========================================" -Level INFO
    Write-Log "Audit Complete" -Level SUCCESS
    Write-Log "========================================" -Level INFO
    Write-Log "Total Folders Processed: $totalFolders" -Level INFO
    Write-Log "Total Files Processed: $processedCount" -Level INFO
    Write-Log "Files Archived: $archivedCount" -Level INFO
    Write-Log "Errors: $errorCount" -Level INFO
    Write-Log "Log file: $LogFile" -Level INFO
    Write-Log "========================================" -Level INFO
    
    # Database summary query
    Write-Log "" -Level INFO
    Write-Log "Database Summary:" -Level INFO
    Write-Log "- Query FolderStructure table to see folder hierarchy" -Level INFO
    Write-Log "- Query FileAudit table to see all file details" -Level INFO
    Write-Log "- Query FilePermissions table to see who can access/edit files" -Level INFO
    Write-Log "- Query FolderPermissions table to see folder access rights" -Level INFO
    Write-Log "" -Level INFO
    Write-Log "Example queries:" -Level INFO
    Write-Log "  -- Find all users who can edit files:" -Level INFO
    Write-Log "  SELECT DISTINCT IdentityReference FROM FilePermissions WHERE CanWrite = 1 OR CanModify = 1" -Level INFO
    Write-Log "" -Level INFO
    Write-Log "  -- Find files not accessed in 180+ days:" -Level INFO
    Write-Log "  SELECT FileName, LastAccessTime, DaysSinceLastAccess, Owner FROM FileAudit WHERE DaysSinceLastAccess > 180" -Level INFO
}#Requires -Version 5.1
<#
.SYNOPSIS
    Audit and archive file server data with Azure SQL Database tracking
.DESCRIPTION
    Scans UNC path, audits file metadata, archives inactive files to Azure Storage,
    and tracks everything in Azure SQL Database
.NOTES
    Version: 1.0
    Author: File Server Audit System
#>

# ============================================================================
# CONFIGURATION SECTION - UPDATE THESE VALUES
# ============================================================================

# File Server Configuration
$UNCPath = "\\FS\FSDEMO"
$InactiveDaysThreshold = 180

# Azure SQL Database Configuration
$SqlServer = "demoarchetype.database.windows.net"
$SqlDatabase = "demo"
$SqlUsername = "archetype"
$SqlPassword = "ndnts1!Cdnch"

# Azure Storage Configuration (for archived files)
$StorageAccountName = "serverlesscodeb721"
$StorageAccountKey = "8BaUlhfQYl5WY5OLf1yRXcrnCQCt5r/Tl1tqE+pZw+qtF20iH216OCgOnVz07CMxzqVjiHMaDX1e+AStAleg1Q=="
$ArchiveContainerName = "archived-files"

# Logging Configuration
$LogPath = "C:\Logs\FileAudit"
$LogFile = Join-Path $LogPath "FileAudit_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# ============================================================================
# INITIALIZATION
# ============================================================================

# Create log directory if it doesn't exist
if (-not (Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
}

# Logging function
function Write-Log {
    param(
        [string]$Message,
        [ValidateSet('INFO','WARNING','ERROR','SUCCESS')]
        [string]$Level = 'INFO'
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    Add-Content -Path $LogFile -Value $logMessage
    
    switch ($Level) {
        'ERROR' { Write-Host $logMessage -ForegroundColor Red }
        'WARNING' { Write-Host $logMessage -ForegroundColor Yellow }
        'SUCCESS' { Write-Host $logMessage -ForegroundColor Green }
        default { Write-Host $logMessage }
    }
}

Write-Log "========================================" -Level INFO
Write-Log "File Server Audit & Archive Script Started" -Level INFO
Write-Log "========================================" -Level INFO

# ============================================================================
# DATABASE FUNCTIONS
# ============================================================================

function Get-SqlConnection {
    try {
        $connectionString = "Server=tcp:$SqlServer,1433;Initial Catalog=$SqlDatabase;Persist Security Info=False;User ID=$SqlUsername;Password=$SqlPassword;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        
        $connection = New-Object System.Data.SqlClient.SqlConnection
        $connection.ConnectionString = $connectionString
        $connection.Open()
        
        Write-Log "Successfully connected to Azure SQL Database" -Level SUCCESS
        return $connection
    }
    catch {
        Write-Log "Failed to connect to database: $($_.Exception.Message)" -Level ERROR
        throw
    }
}

function Initialize-Database {
    param($Connection)
    
    $createTableQuery = @"
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'FolderStructure')
BEGIN
    CREATE TABLE FolderStructure (
        Id INT IDENTITY(1,1) PRIMARY KEY,
        FolderPath NVARCHAR(MAX) NOT NULL,
        FolderName NVARCHAR(500) NOT NULL,
        ParentFolderPath NVARCHAR(MAX),
        FolderLevel INT,
        CreationTime DATETIME2,
        LastModifiedTime DATETIME2,
        LastAccessTime DATETIME2,
        Owner NVARCHAR(500),
        TotalFiles INT DEFAULT 0,
        TotalSubfolders INT DEFAULT 0,
        TotalSizeBytes BIGINT DEFAULT 0,
        AuditDate DATETIME2 DEFAULT GETDATE()
    );
    
    CREATE NONCLUSTERED INDEX IX_FolderStructure_FolderPath ON FolderStructure(FolderPath);
    CREATE NONCLUSTERED INDEX IX_FolderStructure_ParentFolderPath ON FolderStructure(ParentFolderPath);
END

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'FileAudit')
BEGIN
    CREATE TABLE FileAudit (
        Id INT IDENTITY(1,1) PRIMARY KEY,
        FilePath NVARCHAR(MAX) NOT NULL,
        FileName NVARCHAR(500) NOT NULL,
        FileExtension NVARCHAR(50),
        FolderPath NVARCHAR(MAX) NOT NULL,
        FolderStructureId INT,
        FileSizeBytes BIGINT,
        FileSizeMB DECIMAL(18,2),
        CreationTime DATETIME2,
        LastModifiedTime DATETIME2,
        LastAccessTime DATETIME2,
        Owner NVARCHAR(500),
        Status NVARCHAR(50),
        IsArchived BIT DEFAULT 0,
        ArchiveDate DATETIME2,
        ArchiveURL NVARCHAR(MAX),
        Checksum NVARCHAR(64),
        DaysSinceLastAccess INT,
        DaysSinceLastModified INT,
        AuditDate DATETIME2 DEFAULT GETDATE(),
        LastUpdated DATETIME2 DEFAULT GETDATE(),
        FOREIGN KEY (FolderStructureId) REFERENCES FolderStructure(Id)
    );
    
    CREATE NONCLUSTERED INDEX IX_FileAudit_Status ON FileAudit(Status);
    CREATE NONCLUSTERED INDEX IX_FileAudit_IsArchived ON FileAudit(IsArchived);
    CREATE NONCLUSTERED INDEX IX_FileAudit_LastAccessTime ON FileAudit(LastAccessTime);
    CREATE NONCLUSTERED INDEX IX_FileAudit_LastModifiedTime ON FileAudit(LastModifiedTime);
    CREATE NONCLUSTERED INDEX IX_FileAudit_FolderStructureId ON FileAudit(FolderStructureId);
    CREATE NONCLUSTERED INDEX IX_FileAudit_Owner ON FileAudit(Owner);
END

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'FilePermissions')
BEGIN
    CREATE TABLE FilePermissions (
        Id INT IDENTITY(1,1) PRIMARY KEY,
        FileAuditId INT,
        IdentityReference NVARCHAR(500),
        UserDisplayName NVARCHAR(500),
        AccessRights NVARCHAR(500),
        AccessControlType NVARCHAR(50),
        IsInherited BIT,
        CanRead BIT DEFAULT 0,
        CanWrite BIT DEFAULT 0,
        CanModify BIT DEFAULT 0,
        CanDelete BIT DEFAULT 0,
        CanExecute BIT DEFAULT 0,
        FullControl BIT DEFAULT 0,
        AuditDate DATETIME2 DEFAULT GETDATE(),
        FOREIGN KEY (FileAuditId) REFERENCES FileAudit(Id)
    );
    
    CREATE NONCLUSTERED INDEX IX_FilePermissions_FileAuditId ON FilePermissions(FileAuditId);
    CREATE NONCLUSTERED INDEX IX_FilePermissions_Identity ON FilePermissions(IdentityReference);
    CREATE NONCLUSTERED INDEX IX_FilePermissions_CanWrite ON FilePermissions(CanWrite);
    CREATE NONCLUSTERED INDEX IX_FilePermissions_CanModify ON FilePermissions(CanModify);
END

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'FolderPermissions')
BEGIN
    CREATE TABLE FolderPermissions (
        Id INT IDENTITY(1,1) PRIMARY KEY,
        FolderStructureId INT,
        IdentityReference NVARCHAR(500),
        UserDisplayName NVARCHAR(500),
        AccessRights NVARCHAR(500),
        AccessControlType NVARCHAR(50),
        IsInherited BIT,
        CanRead BIT DEFAULT 0,
        CanWrite BIT DEFAULT 0,
        CanModify BIT DEFAULT 0,
        CanDelete BIT DEFAULT 0,
        FullControl BIT DEFAULT 0,
        AuditDate DATETIME2 DEFAULT GETDATE(),
        FOREIGN KEY (FolderStructureId) REFERENCES FolderStructure(Id)
    );
    
    CREATE NONCLUSTERED INDEX IX_FolderPermissions_FolderStructureId ON FolderPermissions(FolderStructureId);
    CREATE NONCLUSTERED INDEX IX_FolderPermissions_Identity ON FolderPermissions(IdentityReference);
END
"@
    
    try {
        $command = $Connection.CreateCommand()
        $command.CommandText = $createTableQuery
        $command.ExecuteNonQuery() | Out-Null
        Write-Log "Database schema initialized successfully" -Level SUCCESS
    }
    catch {
        Write-Log "Failed to initialize database: $($_.Exception.Message)" -Level ERROR
        throw
    }
}

# ============================================================================
# FILE SYSTEM FUNCTIONS
# ============================================================================

function Get-FileOwner {
    param([string]$Path)
    try {
        $acl = Get-Acl -Path $Path -ErrorAction Stop
        return $acl.Owner
    }
    catch {
        return "Unable to retrieve"
    }
}

function Get-FilePermissions {
    param([string]$Path)
    try {
        $acl = Get-Acl -Path $Path -ErrorAction Stop
        $permissions = @()
        
        foreach ($access in $acl.Access) {
            $rights = $access.FileSystemRights
            
            $permissions += [PSCustomObject]@{
                Identity = $access.IdentityReference.Value
                Rights = $rights.ToString()
                Type = $access.AccessControlType.ToString()
                IsInherited = $access.IsInherited
                CanRead = ($rights -band [System.Security.AccessControl.FileSystemRights]::Read) -ne 0
                CanWrite = ($rights -band [System.Security.AccessControl.FileSystemRights]::Write) -ne 0
                CanModify = ($rights -band [System.Security.AccessControl.FileSystemRights]::Modify) -ne 0
                CanDelete = ($rights -band [System.Security.AccessControl.FileSystemRights]::Delete) -ne 0
                CanExecute = ($rights -band [System.Security.AccessControl.FileSystemRights]::ExecuteFile) -ne 0
                FullControl = ($rights -band [System.Security.AccessControl.FileSystemRights]::FullControl) -ne 0
            }
        }
        
        return $permissions
    }
    catch {
        Write-Log "Failed to get permissions for $Path : $($_.Exception.Message)" -Level WARNING
        return @()
    }
}

function Get-FolderPermissions {
    param([string]$Path)
    try {
        $acl = Get-Acl -Path $Path -ErrorAction Stop
        $permissions = @()
        
        foreach ($access in $acl.Access) {
            $rights = $access.FileSystemRights
            
            $permissions += [PSCustomObject]@{
                Identity = $access.IdentityReference.Value
                Rights = $rights.ToString()
                Type = $access.AccessControlType.ToString()
                IsInherited = $access.IsInherited
                CanRead = ($rights -band [System.Security.AccessControl.FileSystemRights]::Read) -ne 0
                CanWrite = ($rights -band [System.Security.AccessControl.FileSystemRights]::Write) -ne 0
                CanModify = ($rights -band [System.Security.AccessControl.FileSystemRights]::Modify) -ne 0
                CanDelete = ($rights -band [System.Security.AccessControl.FileSystemRights]::Delete) -ne 0
                FullControl = ($rights -band [System.Security.AccessControl.FileSystemRights]::FullControl) -ne 0
            }
        }
        
        return $permissions
    }
    catch {
        Write-Log "Failed to get permissions for folder $Path : $($_.Exception.Message)" -Level WARNING
        return @()
    }
}

function Get-FileChecksum {
    param([string]$Path)
    try {
        $hash = Get-FileHash -Path $Path -Algorithm SHA256 -ErrorAction Stop
        return $hash.Hash
    }
    catch {
        Write-Log "Failed to calculate checksum for $Path : $($_.Exception.Message)" -Level WARNING
        return $null
    }
}

# ============================================================================
# AZURE STORAGE FUNCTIONS
# ============================================================================

function Initialize-AzureStorage {
    try {
        # Check if Az.Storage module is available
        if (-not (Get-Module -ListAvailable -Name Az.Storage)) {
            Write-Log "Az.Storage module not found. Installing..." -Level WARNING
            Install-Module -Name Az.Storage -Force -AllowClobber -Scope CurrentUser
        }
        
        Import-Module Az.Storage -ErrorAction Stop
        
        $ctx = New-AzStorageContext -StorageAccountName $StorageAccountName -StorageAccountKey $StorageAccountKey
        
        # Create container if it doesn't exist
        $container = Get-AzStorageContainer -Name $ArchiveContainerName -Context $ctx -ErrorAction SilentlyContinue
        if (-not $container) {
            New-AzStorageContainer -Name $ArchiveContainerName -Context $ctx -Permission Off | Out-Null
            Write-Log "Created archive container: $ArchiveContainerName" -Level SUCCESS
        }
        
        return $ctx
    }
    catch {
        Write-Log "Failed to initialize Azure Storage: $($_.Exception.Message)" -Level ERROR
        throw
    }
}

function Copy-ToAzureStorage {
    param(
        [string]$FilePath,
        [object]$StorageContext
    )
    
    try {
        $relativePath = $FilePath.Replace($UNCPath, "").TrimStart('\').Replace('\', '/')
        $blobName = "archive/$relativePath"
        
        Set-AzStorageBlobContent -File $FilePath -Container $ArchiveContainerName -Blob $blobName -Context $StorageContext -Force | Out-Null
        
        $blobUrl = "https://$StorageAccountName.blob.core.windows.net/$ArchiveContainerName/$blobName"
        
        Write-Log "Uploaded to Azure Storage: $blobName" -Level SUCCESS
        return $blobUrl
    }
    catch {
        Write-Log "Failed to upload $FilePath to Azure Storage: $($_.Exception.Message)" -Level ERROR
        return $null
    }
}

function Verify-ArchiveChecksum {
    param(
        [string]$OriginalChecksum,
        [string]$BlobUrl,
        [object]$StorageContext
    )
    
    try {
        # Download blob to temp location
        $tempFile = [System.IO.Path]::GetTempFileName()
        $blobName = $BlobUrl.Split("/$ArchiveContainerName/")[1]
        
        Get-AzStorageBlobContent -Blob $blobName -Container $ArchiveContainerName -Context $StorageContext -Destination $tempFile -Force | Out-Null
        
        $archivedChecksum = Get-FileChecksum -Path $tempFile
        Remove-Item $tempFile -Force
        
        return ($OriginalChecksum -eq $archivedChecksum)
    }
    catch {
        Write-Log "Failed to verify checksum: $($_.Exception.Message)" -Level ERROR
        return $false
    }
}

# ============================================================================
# DATABASE INSERT FUNCTIONS
# ============================================================================

function Add-FolderStructureRecord {
    param(
        [System.Data.SqlClient.SqlConnection]$Connection,
        [object]$FolderInfo,
        [string]$ParentPath,
        [int]$Level
    )
    
    $query = @"
INSERT INTO FolderStructure (
    FolderPath, FolderName, ParentFolderPath, FolderLevel,
    CreationTime, LastModifiedTime, LastAccessTime, Owner
)
VALUES (
    @FolderPath, @FolderName, @ParentPath, @Level,
    @CreationTime, @LastModifiedTime, @LastAccessTime, @Owner
);
SELECT CAST(SCOPE_IDENTITY() AS INT);
"@
    
    try {
        $command = $Connection.CreateCommand()
        $command.CommandText = $query
        
        $command.Parameters.AddWithValue("@FolderPath", $FolderInfo.FullName) | Out-Null
        $command.Parameters.AddWithValue("@FolderName", $FolderInfo.Name) | Out-Null
        
        if ($ParentPath) {
            $command.Parameters.AddWithValue("@ParentPath", $ParentPath) | Out-Null
        } else {
            $command.Parameters.AddWithValue("@ParentPath", [DBNull]::Value) | Out-Null
        }
        
        $command.Parameters.AddWithValue("@Level", $Level) | Out-Null
        $command.Parameters.AddWithValue("@CreationTime", $FolderInfo.CreationTime) | Out-Null
        $command.Parameters.AddWithValue("@LastModifiedTime", $FolderInfo.LastWriteTime) | Out-Null
        $command.Parameters.AddWithValue("@LastAccessTime", $FolderInfo.LastAccessTime) | Out-Null
        $command.Parameters.AddWithValue("@Owner", (Get-FileOwner -Path $FolderInfo.FullName)) | Out-Null
        
        $folderId = $command.ExecuteScalar()
        return $folderId
    }
    catch {
        Write-Log "Failed to insert folder structure record: $($_.Exception.Message)" -Level ERROR
        return $null
    }
}

function Update-FolderStatistics {
    param(
        [System.Data.SqlClient.SqlConnection]$Connection,
        [int]$FolderId,
        [int]$FileCount,
        [int]$SubfolderCount,
        [long]$TotalSize
    )
    
    $query = @"
UPDATE FolderStructure
SET TotalFiles = @FileCount,
    TotalSubfolders = @SubfolderCount,
    TotalSizeBytes = @TotalSize
WHERE Id = @FolderId;
"@
    
    try {
        $command = $Connection.CreateCommand()
        $command.CommandText = $query
        
        $command.Parameters.AddWithValue("@FolderId", $FolderId) | Out-Null
        $command.Parameters.AddWithValue("@FileCount", $FileCount) | Out-Null
        $command.Parameters.AddWithValue("@SubfolderCount", $SubfolderCount) | Out-Null
        $command.Parameters.AddWithValue("@TotalSize", $TotalSize) | Out-Null
        
        $command.ExecuteNonQuery() | Out-Null
    }
    catch {
        Write-Log "Failed to update folder statistics: $($_.Exception.Message)" -Level WARNING
    }
}

function Add-FolderPermissionRecords {
    param(
        [System.Data.SqlClient.SqlConnection]$Connection,
        [int]$FolderStructureId,
        [array]$Permissions
    )
    
    $query = @"
INSERT INTO FolderPermissions (
    FolderStructureId, IdentityReference, AccessRights, AccessControlType, 
    IsInherited, CanRead, CanWrite, CanModify, CanDelete, FullControl
)
VALUES (
    @FolderStructureId, @Identity, @Rights, @Type, 
    @IsInherited, @CanRead, @CanWrite, @CanModify, @CanDelete, @FullControl
);
"@
    
    foreach ($perm in $Permissions) {
        try {
            $command = $Connection.CreateCommand()
            $command.CommandText = $query
            
            $command.Parameters.AddWithValue("@FolderStructureId", $FolderStructureId) | Out-Null
            $command.Parameters.AddWithValue("@Identity", $perm.Identity) | Out-Null
            $command.Parameters.AddWithValue("@Rights", $perm.Rights) | Out-Null
            $command.Parameters.AddWithValue("@Type", $perm.Type) | Out-Null
            $command.Parameters.AddWithValue("@IsInherited", $perm.IsInherited) | Out-Null
            $command.Parameters.AddWithValue("@CanRead", $perm.CanRead) | Out-Null
            $command.Parameters.AddWithValue("@CanWrite", $perm.CanWrite) | Out-Null
            $command.Parameters.AddWithValue("@CanModify", $perm.CanModify) | Out-Null
            $command.Parameters.AddWithValue("@CanDelete", $perm.CanDelete) | Out-Null
            $command.Parameters.AddWithValue("@FullControl", $perm.FullControl) | Out-Null
            
            $command.ExecuteNonQuery() | Out-Null
        }
        catch {
            Write-Log "Failed to insert folder permission record: $($_.Exception.Message)" -Level WARNING
        }
    }
}

function Add-FileAuditRecord {
    param(
        [System.Data.SqlClient.SqlConnection]$Connection,
        [object]$FileInfo,
        [string]$Status,
        [int]$FolderStructureId = $null,
        [bool]$IsArchived = $false,
        [string]$ArchiveURL = $null,
        [string]$Checksum = $null,
        [int]$DaysSinceAccess,
        [int]$DaysSinceModified
    )
    
    $query = @"
INSERT INTO FileAudit (
    FilePath, FileName, FileExtension, FolderPath, FolderStructureId, FileSizeBytes, FileSizeMB,
    CreationTime, LastModifiedTime, LastAccessTime, Owner, Status, IsArchived,
    ArchiveDate, ArchiveURL, Checksum, DaysSinceLastAccess, DaysSinceLastModified
)
VALUES (
    @FilePath, @FileName, @FileExtension, @FolderPath, @FolderStructureId, @FileSizeBytes, @FileSizeMB,
    @CreationTime, @LastModifiedTime, @LastAccessTime, @Owner, @Status, @IsArchived,
    @ArchiveDate, @ArchiveURL, @Checksum, @DaysSinceAccess, @DaysSinceModified
);
SELECT CAST(SCOPE_IDENTITY() AS INT);
"@
    
    try {
        $command = $Connection.CreateCommand()
        $command.CommandText = $query
        
        $command.Parameters.AddWithValue("@FilePath", $FileInfo.FullName) | Out-Null
        $command.Parameters.AddWithValue("@FileName", $FileInfo.Name) | Out-Null
        $command.Parameters.AddWithValue("@FileExtension", $FileInfo.Extension) | Out-Null
        $command.Parameters.AddWithValue("@FolderPath", $FileInfo.DirectoryName) | Out-Null
        
        if ($FolderStructureId) {
            $command.Parameters.AddWithValue("@FolderStructureId", $FolderStructureId) | Out-Null
        } else {
            $command.Parameters.AddWithValue("@FolderStructureId", [DBNull]::Value) | Out-Null
        }
        
        $command.Parameters.AddWithValue("@FileSizeBytes", $FileInfo.Length) | Out-Null
        $command.Parameters.AddWithValue("@FileSizeMB", [math]::Round($FileInfo.Length / 1MB, 2)) | Out-Null
        $command.Parameters.AddWithValue("@CreationTime", $FileInfo.CreationTime) | Out-Null
        $command.Parameters.AddWithValue("@LastModifiedTime", $FileInfo.LastWriteTime) | Out-Null
        $command.Parameters.AddWithValue("@LastAccessTime", $FileInfo.LastAccessTime) | Out-Null
        $command.Parameters.AddWithValue("@Owner", (Get-FileOwner -Path $FileInfo.FullName)) | Out-Null
        $command.Parameters.AddWithValue("@Status", $Status) | Out-Null
        $command.Parameters.AddWithValue("@IsArchived", $IsArchived) | Out-Null
        
        if ($IsArchived) {
            $command.Parameters.AddWithValue("@ArchiveDate", (Get-Date)) | Out-Null
        } else {
            $command.Parameters.AddWithValue("@ArchiveDate", [DBNull]::Value) | Out-Null
        }
        
        if ($ArchiveURL) {
            $command.Parameters.AddWithValue("@ArchiveURL", $ArchiveURL) | Out-Null
        } else {
            $command.Parameters.AddWithValue("@ArchiveURL", [DBNull]::Value) | Out-Null
        }
        
        if ($Checksum) {
            $command.Parameters.AddWithValue("@Checksum", $Checksum) | Out-Null
        } else {
            $command.Parameters.AddWithValue("@Checksum", [DBNull]::Value) | Out-Null
        }
        
        $command.Parameters.AddWithValue("@DaysSinceAccess", $DaysSinceAccess) | Out-Null
        $command.Parameters.AddWithValue("@DaysSinceModified", $DaysSinceModified) | Out-Null
        
        $fileAuditId = $command.ExecuteScalar()
        return $fileAuditId
    }
    catch {
        Write-Log "Failed to insert file audit record: $($_.Exception.Message)" -Level ERROR
        return $null
    }
}

function Add-FilePermissionRecords {
    param(
        [System.Data.SqlClient.SqlConnection]$Connection,
        [int]$FileAuditId,
        [array]$Permissions
    )
    
    $query = @"
INSERT INTO FilePermissions (
    FileAuditId, IdentityReference, AccessRights, AccessControlType, IsInherited,
    CanRead, CanWrite, CanModify, CanDelete, CanExecute, FullControl
)
VALUES (
    @FileAuditId, @Identity, @Rights, @Type, @IsInherited,
    @CanRead, @CanWrite, @CanModify, @CanDelete, @CanExecute, @FullControl
);
"@
    
    foreach ($perm in $Permissions) {
        try {
            $command = $Connection.CreateCommand()
            $command.CommandText = $query
            
            $command.Parameters.AddWithValue("@FileAuditId", $FileAuditId) | Out-Null
            $command.Parameters.AddWithValue("@Identity", $perm.Identity) | Out-Null
            $command.Parameters.AddWithValue("@Rights", $perm.Rights) | Out-Null
            $command.Parameters.AddWithValue("@Type", $perm.Type) | Out-Null
            $command.Parameters.AddWithValue("@IsInherited", $perm.IsInherited) | Out-Null
            $command.Parameters.AddWithValue("@CanRead", $perm.CanRead) | Out-Null
            $command.Parameters.AddWithValue("@CanWrite", $perm.CanWrite) | Out-Null
            $command.Parameters.AddWithValue("@CanModify", $perm.CanModify) | Out-Null
            $command.Parameters.AddWithValue("@CanDelete", $perm.CanDelete) | Out-Null
            $command.Parameters.AddWithValue("@CanExecute", $perm.CanExecute) | Out-Null
            $command.Parameters.AddWithValue("@FullControl", $perm.FullControl) | Out-Null
            
            $command.ExecuteNonQuery() | Out-Null
        }
        catch {
            Write-Log "Failed to insert permission record: $($_.Exception.Message)" -Level WARNING
        }
    }
}

# ============================================================================
# MAIN PROCESSING FUNCTION
# ============================================================================

function Process-FileServerAudit {
    # Validate UNC path
    if (-not (Test-Path $UNCPath)) {
        Write-Log "UNC path not accessible: $UNCPath" -Level ERROR
        return
    }
    
    # Connect to database
    $sqlConnection = Get-SqlConnection
    Initialize-Database -Connection $sqlConnection
    
    # Initialize Azure Storage
    try {
        $storageContext = Initialize-AzureStorage
    }
    catch {
        Write-Log "Proceeding without Azure Storage. Archive functionality will be disabled." -Level WARNING
        $storageContext = $null
    }
    
    # Get all files
    Write-Log "Scanning file server: $UNCPath" -Level INFO
    $files = Get-ChildItem -Path $UNCPath -Recurse -File -ErrorAction SilentlyContinue
    $totalFiles = $files.Count
    Write-Log "Found $totalFiles files to process" -Level INFO
    
    $processedCount = 0
    $archivedCount = 0
    $errorCount = 0
    $currentDate = Get-Date
    
    foreach ($file in $files) {
        $processedCount++
        
        try {
            # Calculate days since last access
            $daysSinceAccess = ($currentDate - $file.LastAccessTime).Days
            
            # Determine status
            if ($daysSinceAccess -le $InactiveDaysThreshold) {
                $status = "Active"
                $isArchived = $false
                $archiveURL = $null
                $checksum = $null
                
                Write-Log "[$processedCount/$totalFiles] Processing (Active): $($file.Name)" -Level INFO
                
                # Insert into database
                $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess
                
                if ($fileAuditId) {
                    # Add permissions
                    $permissions = Get-FilePermissions -Path $file.FullName
                    Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                }
            }
            else {
                # File is inactive - archive it
                Write-Log "[$processedCount/$totalFiles] Processing (Inactive - Archiving): $($file.Name)" -Level WARNING
                
                # Calculate checksum before archiving
                $checksum = Get-FileChecksum -Path $file.FullName
                
                if ($storageContext) {
                    # Upload to Azure Storage
                    $archiveURL = Copy-ToAzureStorage -FilePath $file.FullName -StorageContext $storageContext
                    
                    if ($archiveURL) {
                        # Verify checksum
                        $checksumMatch = Verify-ArchiveChecksum -OriginalChecksum $checksum -BlobUrl $archiveURL -StorageContext $storageContext
                        
                        if ($checksumMatch) {
                            $status = "Archived"
                            $isArchived = $true
                            
                            # Insert into database
                            $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess
                            
                            if ($fileAuditId) {
                                # Add permissions
                                $permissions = Get-FilePermissions -Path $file.FullName
                                Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                                
                                # Delete original file
                                Remove-Item -Path $file.FullName -Force
                                Write-Log "Successfully archived and deleted: $($file.Name)" -Level SUCCESS
                                $archivedCount++
                            }
                        }
                        else {
                            Write-Log "Checksum mismatch for $($file.Name) - File NOT deleted" -Level ERROR
                            $errorCount++
                        }
                    }
                    else {
                        Write-Log "Failed to upload $($file.Name) - File NOT deleted" -Level ERROR
                        $errorCount++
                    }
                }
                else {
                    # No storage context - just mark as inactive
                    $status = "Inactive"
                    $isArchived = $false
                    $archiveURL = $null
                    
                    $fileAuditId = Add-FileAuditRecord -Connection $sqlConnection -FileInfo $file -Status $status -IsArchived $isArchived -ArchiveURL $archiveURL -Checksum $checksum -DaysSinceAccess $daysSinceAccess
                    
                    if ($fileAuditId) {
                        $permissions = Get-FilePermissions -Path $file.FullName
                        Add-FilePermissionRecords -Connection $sqlConnection -FileAuditId $fileAuditId -Permissions $permissions
                    }
                }
            }
            
            # Progress indicator
            if ($processedCount % 100 -eq 0) {
                Write-Log "Progress: $processedCount/$totalFiles files processed" -Level INFO
            }
        }
        catch {
            Write-Log "Error processing file $($file.FullName): $($_.Exception.Message)" -Level ERROR
            $errorCount++
        }
    }
    
    # Close database connection
    $sqlConnection.Close()
    
    # Summary
    Write-Log "========================================" -Level INFO
    Write-Log "Audit Complete" -Level SUCCESS
    Write-Log "Total Files Processed: $processedCount" -Level INFO
    Write-Log "Files Archived: $archivedCount" -Level INFO
    Write-Log "Errors: $errorCount" -Level INFO
    Write-Log "Log file: $LogFile" -Level INFO
    Write-Log "========================================" -Level INFO
}

# ============================================================================
# SCRIPT EXECUTION
# ============================================================================

try {
    Process-FileServerAudit
}
catch {
    Write-Log "Critical error: $($_.Exception.Message)" -Level ERROR
    Write-Log $_.ScriptStackTrace -Level ERROR
}

Write-Log "Script execution completed" -Level INFO
